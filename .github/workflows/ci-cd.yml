name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_IMAGE_NAME: mi-app-html
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  test:
    name: Ejecutar pruebas
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3

    - name: Verificar estructura de archivos
      run: |
        echo "ðŸ“ Contenido del repositorio:"
        ls -la
        echo ""
        echo "ðŸ“„ Contenido de index.html:"
        head -20 index.html
        echo ""
        echo "ðŸ” Verificando si existe el texto requerido:"
        if grep -q "Hola Mundo DevOps" index.html; then
          echo "âœ… Texto 'Hola Mundo DevOps' encontrado en index.html"
        else
          echo "âŒ Texto 'Hola Mundo DevOps' NO encontrado en index.html"
          exit 1
        fi
        
        if grep -q "funcionando correctamente" index.html; then
          echo "âœ… Texto 'funcionando correctamente' encontrado en index.html"
        else
          echo "âŒ Texto 'funcionando correctamente' NO encontrado en index.html"
          exit 1
        fi

    - name: Configurar Python para servidor de pruebas
      run: |
        # Usaremos el servidor HTTP integrado de Python
        python3 --version

    - name: Ejecutar pruebas con servidor HTTP
      run: |
        # Iniciar servidor en segundo plano
        python3 -m http.server 8080 &
        SERVER_PID=$!
        
        # Esperar a que el servidor inicie
        sleep 5
        
        # Verificar que el servidor estÃ¡ funcionando
        if curl -f http://localhost:8080/index.html; then
          echo "âœ… Servidor HTTP funcionando correctamente"
        else
          echo "âŒ Error: Servidor HTTP no responde"
          exit 1
        fi
        
        # Ejecutar pruebas verificando el contenido HTML
        echo "ðŸ§ª Ejecutando pruebas..."
        
        # Prueba 1: Verificar que el tÃ­tulo existe
        if curl -s http://localhost:8080/index.html | grep -q "Hola Mundo DevOps"; then
          echo "âœ… Prueba 1 pasÃ³: TÃ­tulo encontrado"
        else
          echo "âŒ Prueba 1 fallÃ³: TÃ­tulo no encontrado"
          echo "Contenido de la respuesta:"
          curl -s http://localhost:8080/index.html | head -10
          exit 1
        fi
        
        # Prueba 2: Verificar que el estado es correcto
        if curl -s http://localhost:8080/index.html | grep -q "funcionando correctamente"; then
          echo "âœ… Prueba 2 pasÃ³: Estado correcto"
        else
          echo "âŒ Prueba 2 fallÃ³: Estado incorrecto"
          exit 1
        fi
        
        # Prueba 3: Verificar que la pÃ¡gina contiene CI/CD
        if curl -s http://localhost:8080/index.html | grep -q "CI/CD"; then
          echo "âœ… Prueba 3 pasÃ³: Contenido CI/CD encontrado"
        else
          echo "âŒ Prueba 3 fallÃ³: Contenido CI/CD no encontrado"
          exit 1
        fi
        
        # Detener servidor
        kill $SERVER_PID
        echo "ðŸŽ‰ Todas las pruebas pasaron correctamente"

  build-and-push:
    name: Construir y publicar imagen Docker
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && success()
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login a Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Extraer metadatos para Docker
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix=,suffix=,format=short
          type=raw,value=latest

    - name: Construir y publicar imagen Docker
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}

    - name: Verificar imagen publicada
      run: |
        echo "âœ… Imagen publicada en Docker Hub: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}"
        echo "ðŸ“¦ Tags: ${{ steps.meta.outputs.tags }}"

  deploy-render:
  name: Desplegar en Render
  runs-on: ubuntu-latest
  needs: build-and-push
  if: github.event_name == 'push' && success()
  
  steps:
  - name: Checkout cÃ³digo
    uses: actions/checkout@v3

  - name: Configurar despliegue en Render
    env:
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
    run: |
      # Verificar que tenemos las credenciales necesarias
      if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
        echo "âš ï¸  Advertencia: No se configuraron los secrets para Render"
        echo "Para desplegar en Render, configura RENDER_API_KEY y RENDER_SERVICE_ID en los secrets de GitHub"
        exit 0
      fi

      echo "ðŸš€ Iniciando despliegue en Render..."
      echo "ðŸ”‘ API Key: ${RENDER_API_KEY:0:10}..."  # Muestra solo los primeros 10 caracteres por seguridad
      echo "ðŸ†” Service ID: $RENDER_SERVICE_ID"
      
      # Crear un archivo JSON temporal con el formato correcto
      cat > deploy-data.json << EOF
      {
        "clearCache": true
      }
EOF

      # Realizar deploy usando la API de Render con el formato correcto
      RESPONSE=$(curl -s -w "%{http_code}" \
        -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
        -H "Authorization: Bearer $RENDER_API_KEY" \
        -H "Content-Type: application/json" \
        --data-binary "@deploy-data.json")
      
      HTTP_CODE=${RESPONSE: -3}
      RESPONSE_BODY=${RESPONSE:0:${#RESPONSE}-3}
      
      echo "ðŸ“‹ CÃ³digo de respuesta: $HTTP_CODE"
      echo "ðŸ“„ Cuerpo de respuesta: $RESPONSE_BODY"
      
      if [ "$HTTP_CODE" -eq 201 ]; then
        DEPLOY_ID=$(echo "$RESPONSE_BODY" | grep -o '"id":"[^"]*' | cut -d'"' -f4)
        echo "âœ… Despliegue iniciado correctamente. ID: $DEPLOY_ID"
        echo "ðŸ“Š Puedes ver el progreso en: https://dashboard.render.com/web/$SERVICE_ID"
      else
        echo "âŒ Error al iniciar el despliegue. CÃ³digo de respuesta: $HTTP_CODE"
        echo "ðŸ“ Mensaje: $RESPONSE_BODY"
        exit 1
      fi

  - name: Notificar Ã©xito
    if: success()
    run: |
      echo "ðŸŽ‰ Â¡Pipeline completado con Ã©xito!"
      echo "ðŸ“¦ Imagen Docker: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest"
      echo "ðŸŒ AplicaciÃ³n desplegada en Render"
